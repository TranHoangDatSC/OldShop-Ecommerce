<!DOCTYPE html>
<html>
<head>
    <title>Quản Lý Kiểm Duyệt Viên - Admin</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Cơ bản (Chỉ giữ lại những style quan trọng nhất) */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding-top: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); position: fixed; height: 100%; overflow-y: auto; }
        .sidebar a { padding: 15px 20px; text-decoration: none; font-size: 16px; color: #ecf0f1; display: block; transition: background-color 0.3s; border-left: 5px solid transparent; }
        .sidebar a:hover, .sidebar a.active { background-color: #34495e; border-left: 5px solid #3498db; color: white; }
        .sidebar a i { margin-right: 10px; width: 20px; text-align: center; }
        .main-content { margin-left: 250px; flex-grow: 1; padding: 20px; }
        .header-bar { background: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .content-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .mod-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .mod-table th, .mod-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .mod-table th { background-color: #f8f8f8; font-weight: bold; color: #333; }
        .action-btn { padding: 5px 10px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: background-color 0.3s; }
        .edit-btn { background-color: #3498db; }
        .toggle-status-btn.active { background-color: #e74c3c; } 
        .toggle-status-btn.inactive { background-color: #2ecc71; } 
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .status-pill.active { background-color: #2ecc71; color: white; }
        .status-pill.inactive { background-color: #e74c3c; color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 40%; border-radius: 8px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content input, .modal-content button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .modal-content button.primary { background-color: #3498db; color: white; border: none; }
    </style>
</head>
<body>

    <div class="sidebar">
    <h3><i class="fas fa-store"></i> Chợ Đồ Cũ</h3>
    
        <div style="padding: 10px 0;">
            <a href="/admin/dashboard_admin.html"><i class="fas fa-chart-line"></i> Dashboard</a>
            
            <h4 style="color: #bdc3c7; font-size: 0.9em; padding: 10px 20px 5px;">Quản lý Chung</h4>
            
            <a href="/admin/admin_moderators.html" class="active"><i class="fas fa-user-tie"></i> Quản lý Kiểm duyệt viên</a>
            
            <a href="/admin/admin_users.html"><i class="fas fa-users"></i> Quản lý Khách hàng</a>
            
            <a href="/admin/orders.html"><i class="fas fa-file-invoice"></i> Quản lý Hóa đơn</a>
            
            <h4 style="color: #bdc3c7; font-size: 0.9em; padding: 10px 20px 5px;">Quản lý Sản phẩm</h4>
            
            <a href="/admin/products.html"><i class="fas fa-box"></i> Quản lý Sản phẩm</a>
            
            <a href="/admin/categories.html"><i class="fas fa-tags"></i> Quản lý Danh mục</a>
            
            <h4 style="color: #bdc3c7; font-size: 0.9em; padding: 10px 20px 5px;">Khác</h4>
            
            <a href="/admin/settings.html"><i class="fas fa-cog"></i> Cài đặt</a>
        </div>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <h2>Quản Lý Kiểm Duyệt Viên</h2>
            <button class="action-btn edit-btn" onclick="openCreateModeratorModal()">
                <i class="fas fa-plus"></i> Tạo Moderator Mới
            </button>
        </div>
        
        <div class="content-box">
            <h3>Danh sách Tài khoản Moderator</h3>
            <table class="mod-table" id="moderatorsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Tên đầy đủ</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="moderatorModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Tạo Tài khoản Moderator Mới</h3>
            
            <form id="moderatorForm">
                <input type="hidden" id="modUserID" name="UserID">

                <input type="text" id="modUsername" name="Username" placeholder="Username" required>
                <input type="email" id="modEmail" name="Email" placeholder="Email" required>
                <input type="text" id="modFullName" name="FullName" placeholder="Tên đầy đủ" required>
                
                <input type="password" id="modPassword" name="Password" placeholder="Mật khẩu (tối thiểu 6 ký tự)" required>
                
                <div style="margin-bottom: 10px; font-style: italic; color: #7f8c8d;">
                    Vai trò mặc định: Moderator (RoleID=2).
                </div>

                <button type="submit" class="primary" id="submitBtn">Tạo & Kích hoạt</button>
            </form>
        </div>
    </div>

    <script>
    const modal = document.getElementById('moderatorModal');
    const form = document.getElementById('moderatorForm');
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('submitBtn');
    const tableBody = document.querySelector('#moderatorsTable tbody');

    // Biến toàn cục để theo dõi UserID đang được chỉnh sửa/tạo mới
    let currentUserId = null; 

    // --- CÁC HÀM XỬ LÝ GIAO DIỆN CHUNG ---

    function openCreateModeratorModal() {
        modalTitle.textContent = 'Tạo Tài khoản Moderator Mới';
        submitBtn.textContent = 'Tạo & Kích hoạt';
        form.reset(); 
        
        // Thiết lập cho chế độ TẠO MỚI (POST)
        currentUserId = null; 
        document.getElementById('modUserID').value = '';
        document.getElementById('modPassword').placeholder = "Mật khẩu (tối thiểu 6 ký tự)";
        // Mật khẩu là bắt buộc khi tạo mới
        document.getElementById('modPassword').required = true; 
        
        modal.style.display = 'block';
    }

    function closeModal() {
        modal.style.display = 'none';
        // Đặt lại trạng thái required sau khi đóng
        document.getElementById('modPassword').required = false; 
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    // --- HÀM LẤY VÀ ĐIỀN DỮ LIỆU ĐỂ SỬA ---

    async function editModerator(userId) {
        currentUserId = userId;
        modalTitle.textContent = `Sửa Tài khoản Moderator ID: ${userId}`;
        submitBtn.textContent = 'Cập nhật';
        form.reset();
        
        // Thiết lập cho chế độ CHỈNH SỬA (PUT)
        document.getElementById('modUserID').value = userId;
        document.getElementById('modPassword').placeholder = "Mật khẩu (để trống nếu không đổi)";
        // Mật khẩu không bắt buộc khi chỉnh sửa
        document.getElementById('modPassword').required = false; 

        try {
            const response = await fetch(`/api/v1/users/moderator/${userId}`, { method: 'GET' });
            
            if (response.ok) {
                const modData = await response.json();
                
                // Điền dữ liệu vào Form
                document.getElementById('modUsername').value = modData.Username;
                document.getElementById('modEmail').value = modData.Email;
                document.getElementById('modFullName').value = modData.FullName;
                
                modal.style.display = 'block';
            } else {
                const errorData = await response.json();
                alert(`Lỗi khi lấy dữ liệu: ${errorData.detail || 'Không tìm thấy Moderator.'}`);
            }
        } catch (error) {
            console.error('Lỗi API Get:', error);
            alert('Lỗi kết nối khi lấy dữ liệu.');
        }
    }

    // --- HÀM TẢI DỮ LIỆU BẢNG ---

    async function fetchModerators() {
        tableBody.innerHTML = '<tr><td colspan="6">Đang tải dữ liệu...</td></tr>';
        // ... (Giữ nguyên logic fetchModerators và renderTable)
        try {
            const response = await fetch('/api/v1/users/moderator', {
                method: 'GET',
            });

            if (response.ok) {
                const moderators = await response.json();
                renderTable(moderators);
            } else {
                const errorData = await response.json();
                tableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Lỗi tải dữ liệu: ${errorData.detail || 'Lỗi không xác định'}</td></tr>`;
            }
        } catch (error) {
            console.error('Lỗi API:', error);
            tableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Không thể kết nối đến máy chủ API.</td></tr>';
        }
    }

    function renderTable(moderators) {
        tableBody.innerHTML = ''; 
        if (moderators.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6">Chưa có tài khoản Moderator nào.</td></tr>';
            return;
        }

        moderators.forEach(mod => {
            const statusText = mod.IsActive ? 'Active' : 'Inactive';
            const statusClass = mod.IsActive ? 'active' : 'inactive';
            const actionText = mod.IsActive ? 'Deactivate' : 'Activate';
            const actionIcon = mod.IsActive ? 'fas fa-ban' : 'fas fa-check';
            const actionClass = mod.IsActive ? 'active' : 'inactive';

            const row = `
                <tr>
                    <td>${mod.UserID}</td>
                    <td>${mod.Username}</td>
                    <td>${mod.Email}</td>
                    <td>${mod.FullName}</td>
                    <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editModerator(${mod.UserID})"><i class="fas fa-edit"></i> Sửa</button>
                        <button class="action-btn toggle-status-btn ${actionClass}" data-user-id="${mod.UserID}" data-status="${statusClass}" onclick="toggleStatus(${mod.UserID}, ${mod.IsActive})">
                            <i class="${actionIcon}"></i> ${actionText}
                        </button>
                    </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
    }

    // --- XỬ LÝ SUBMIT FORM (Tạo HOẶC Sửa Moderator) ---

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const userData = Object.fromEntries(formData.entries());
        
        const isEditing = currentUserId !== null;
        let url = '/api/v1/users/moderator';
        let method = 'POST';

        let userPayload = {
            Username: userData.Username,
            Email: userData.Email,
            FullName: userData.FullName,
        };
        
        // Chỉ thêm Password nếu có giá trị (PUT) hoặc bắt buộc (POST)
        if (userData.Password) {
            userPayload.Password = userData.Password;
        }

        if (isEditing) {
            url = `/api/v1/users/moderator/${currentUserId}`;
            method = 'PUT';
            
            // Xóa trường username/email nếu không thay đổi (Để tránh lỗi unique khi trùng với chính nó)
            // Tốt nhất là backend nên tự xử lý, nhưng frontend loại bỏ các trường trống/không đổi là một cách an toàn.
            // Tuy nhiên, vì form luôn điền các trường ngoại trừ Password, chúng ta chỉ cần đảm bảo backend xử lý logic unique đúng.
        } else {
            // Đảm bảo Password có khi tạo mới
            if (!userPayload.Password) {
                alert("Vui lòng nhập mật khẩu cho tài khoản mới.");
                return;
            }
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang xử lý...';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userPayload)
            });

            if (response.ok) {
                alert(`Thao tác ${isEditing ? 'Cập nhật' : 'Tạo'} tài khoản Moderator thành công!`);
                closeModal();
                fetchModerators(); 
            } else {
                const errorData = await response.json();
                alert(`Lỗi: ${errorData.detail || 'Không thể thực hiện thao tác.'}`);
            }
        } catch (error) {
            console.error('Lỗi kết nối:', error);
            alert('Lỗi kết nối đến máy chủ.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = isEditing ? 'Cập nhật' : 'Tạo & Kích hoạt';
        }
    });

    // --- HÀM HÀNH ĐỘNG KHÁC (Chưa triển khai API) ---
    function toggleStatus(userId, isActive) {
        const action = isActive ? 'Deactivate' : 'Activate';
        alert(`Chức năng ${action} tài khoản ID: ${userId} đang được phát triển.`);
    }
    // admin_moderators.html (Phần Script)

// ... (các hàm fetchModerators, renderTable, editModerator, openCreateModeratorModal, closeModal)

    // --- HÀM HÀNH ĐỘNG KÍCH HOẠT/VÔ HIỆU HÓA ---
    async function toggleStatus(userId, currentIsActive) {
        const newIsActive = !currentIsActive;
        const action = newIsActive ? 'Kích hoạt' : 'Vô hiệu hóa';

        if (!confirm(`Bạn có chắc chắn muốn ${action} tài khoản Moderator ID: ${userId}?`)) {
            return;
        }

        const toggleBtn = document.querySelector(`button[data-user-id="${userId}"]`);
        toggleBtn.disabled = true;
        const originalText = toggleBtn.innerHTML;
        toggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';


        try {
            const response = await fetch(`/api/v1/users/moderator/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ IsActive: newIsActive }) // CHỈ GỬI TRƯỜNG IsActive
            });

            if (response.ok) {
                alert(`${action} tài khoản ID ${userId} thành công!`);
                fetchModerators(); // Tải lại bảng để cập nhật trạng thái
            } else {
                const errorData = await response.json();
                alert(`Lỗi khi ${action.toLowerCase()}: ${errorData.detail || 'Không thể cập nhật trạng thái.'}`);
            }
        } catch (error) {
            console.error('Lỗi kết nối:', error);
            alert('Lỗi kết nối đến máy chủ.');
        } finally {
            toggleBtn.disabled = false;
            toggleBtn.innerHTML = originalText; // Khôi phục trạng thái nút (sẽ bị ghi đè bởi fetchModerators)
        }
    }
    // --- KHỞI TẠO ---
    document.addEventListener('DOMContentLoaded', fetchModerators);
</script>
</body>
</html>