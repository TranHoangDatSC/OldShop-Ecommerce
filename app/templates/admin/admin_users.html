<!DOCTYPE html>
<html>
<head>
    <title>Quản Lý Khách Hàng - Admin</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Lấy từ admin_moderator.html */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding-top: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); position: fixed; height: 100%; overflow-y: auto; }
        .sidebar a { padding: 15px 20px; text-decoration: none; font-size: 16px; color: #ecf0f1; display: block; transition: background-color 0.3s; border-left: 5px solid transparent; }
        .sidebar a:hover, .sidebar a.active { background-color: #34495e; border-left: 5px solid #3498db; color: white; }
        .sidebar a i { margin-right: 10px; width: 20px; text-align: center; }
        .main-content { margin-left: 250px; flex-grow: 1; padding: 20px; }
        .header-bar { background: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .content-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .user-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .user-table th, .user-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .user-table th { background-color: #f8f8f8; font-weight: bold; color: #333; }
        .action-btn { padding: 5px 10px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: background-color 0.3s; }
        .edit-btn { background-color: #3498db; }
        .toggle-status-btn.active { background-color: #e74c3c; } /* Deactivate/Khóa */
        .toggle-status-btn.inactive { background-color: #2ecc71; } /* Activate/Mở khóa */
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .status-pill.active { background-color: #2ecc71; color: white; }
        .status-pill.inactive { background-color: #e74c3c; color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 40%; border-radius: 8px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content input, .modal-content button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .modal-content button.primary { background-color: #3498db; color: white; border: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3><i class="fas fa-store"></i> Chợ Đồ Cũ</h3>
        
        <div style="padding: 10px 0;">
            <a href="/admin/dashboard_admin.html"><i class="fas fa-chart-line"></i> Dashboard</a>
            
            <h4 style="color: #bdc3c7; font-size: 0.9em; padding: 10px 20px 5px;">Quản lý Chung</h4>
            
            <a href="/admin/admin_moderators.html"><i class="fas fa-user-tie"></i> Quản lý Kiểm duyệt viên</a>
            
            <a href="/admin/users.html" class="active"><i class="fas fa-users"></i> Quản lý Khách hàng</a>
            
            <a href="/admin/orders.html"><i class="fas fa-file-invoice"></i> Quản lý Hóa đơn</a>
            
            <h4 style="color: #bdc3c7; font-size: 0.9em; padding: 10px 20px 5px;">Quản lý Sản phẩm</h4>
            
            <a href="/admin/products.html"><i class="fas fa-box"></i> Quản lý Sản phẩm</a>
            
            <a href="/admin/categories.html"><i class="fas fa-tags"></i> Quản lý Danh mục</a>
            
            <h4 style="color: #bdc3c7; font-size: 0.9em; padding: 10px 20px 5px;">Khác</h4>
            
            <a href="/admin/settings.html"><i class="fas fa-cog"></i> Cài đặt</a>
        </div>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <h2>Quản Lý Khách Hàng</h2>
            </div>
        
        <div class="content-box">
            <h3>Danh sách Tài khoản Khách hàng (RoleID=3)</h3>
            <table class="user-table" id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Tên đầy đủ</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Sửa Tài khoản Khách hàng</h3>
            
            <form id="userForm">
                <input type="hidden" id="customerUserID" name="UserID">

                <input type="text" id="customerUsername" name="Username" placeholder="Username" required>
                <input type="email" id="customerEmail" name="Email" placeholder="Email" required>
                <input type="text" id="customerFullName" name="FullName" placeholder="Tên đầy đủ" required>
                
                <input type="password" id="customerPassword" name="Password" placeholder="Mật khẩu (để trống nếu không đổi)">
                
                <div style="margin-bottom: 10px; font-style: italic; color: #7f8c8d;">
                    Vai trò: Khách hàng (RoleID=3).
                </div>

                <button type="submit" class="primary" id="submitBtn">Cập nhật</button>
            </form>
        </div>
    </div>

    <script>
    const modal = document.getElementById('userModal');
    const form = document.getElementById('userForm');
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('submitBtn');
    const tableBody = document.querySelector('#usersTable tbody');

    let currentUserId = null; 
    const CUSTOMER_API_BASE = '/api/v1/users/customer'; // <--- API Endpoint cho Khách hàng

    // --- CÁC HÀM XỬ LÝ GIAO DIỆN CHUNG ---

    function closeModal() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    // --- HÀM LẤY VÀ ĐIỀN DỮ LIỆU ĐỂ SỬA ---

    async function editCustomer(userId) {
        currentUserId = userId;
        modalTitle.textContent = `Sửa Tài khoản Khách hàng ID: ${userId}`;
        submitBtn.textContent = 'Cập nhật';
        form.reset();
        
        document.getElementById('customerUserID').value = userId;
        document.getElementById('customerPassword').placeholder = "Mật khẩu (để trống nếu không đổi)";
        document.getElementById('customerPassword').required = false; 

        try {
            // SỬ DỤNG API ENDPOINT MỚI CHO CUSTOMER
            const response = await fetch(`${CUSTOMER_API_BASE}/${userId}`, { method: 'GET' });
            
            if (response.ok) {
                const userData = await response.json();
                
                // Điền dữ liệu vào Form
                document.getElementById('customerUsername').value = userData.Username;
                document.getElementById('customerEmail').value = userData.Email;
                document.getElementById('customerFullName').value = userData.FullName;
                
                modal.style.display = 'block';
            } else {
                const errorData = await response.json();
                alert(`Lỗi khi lấy dữ liệu: ${errorData.detail || 'Không tìm thấy Khách hàng.'}`);
            }
        } catch (error) {
            console.error('Lỗi API Get:', error);
            alert('Lỗi kết nối khi lấy dữ liệu.');
        }
    }

    // --- HÀM TẢI DỮ LIỆU BẢNG ---

    async function fetchCustomers() {
        tableBody.innerHTML = '<tr><td colspan="6">Đang tải dữ liệu...</td></tr>';
        
        try {
            // SỬ DỤNG API ENDPOINT MỚI CHO CUSTOMER (Lấy danh sách)
            const response = await fetch(CUSTOMER_API_BASE, { method: 'GET' });

            if (response.ok) {
                const customers = await response.json();
                renderTable(customers);
            } else {
                const errorData = await response.json();
                tableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Lỗi tải dữ liệu: ${errorData.detail || 'Lỗi không xác định'}</td></tr>`;
            }
        } catch (error) {
            console.error('Lỗi API:', error);
            tableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Không thể kết nối đến máy chủ API.</td></tr>';
        }
    }

    function renderTable(customers) {
        tableBody.innerHTML = ''; 
        if (customers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6">Chưa có tài khoản Khách hàng nào.</td></tr>';
            return;
        }

        customers.forEach(user => {
            const statusText = user.IsActive ? 'Active' : 'Bị khóa';
            const statusClass = user.IsActive ? 'active' : 'inactive';
            const actionText = user.IsActive ? 'Khóa' : 'Mở khóa';
            const actionIcon = user.IsActive ? 'fas fa-ban' : 'fas fa-check';
            const actionClass = user.IsActive ? 'active' : 'inactive';

            const row = `
                <tr>
                    <td>${user.UserID}</td>
                    <td>${user.Username}</td>
                    <td>${user.Email}</td>
                    <td>${user.FullName}</td>
                    <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editCustomer(${user.UserID})"><i class="fas fa-edit"></i> Sửa</button>
                        <button class="action-btn toggle-status-btn ${actionClass}" data-user-id="${user.UserID}" data-status="${statusClass}" onclick="toggleStatus(${user.UserID}, ${user.IsActive})">
                            <i class="${actionIcon}"></i> ${actionText}
                        </button>
                    </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
    }

    // --- XỬ LÝ SUBMIT FORM (Sửa Khách hàng) ---

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const userData = Object.fromEntries(formData.entries());
        
        // Vì đây là trang Khách hàng, chúng ta luôn ở chế độ chỉnh sửa (PUT)
        let url = `${CUSTOMER_API_BASE}/${currentUserId}`;
        let method = 'PUT';

        let userPayload = {
            Username: userData.Username,
            Email: userData.Email,
            FullName: userData.FullName,
        };
        
        // Chỉ thêm Password nếu có giá trị
        if (userData.Password) {
            userPayload.Password = userData.Password;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang xử lý...';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userPayload)
            });

            if (response.ok) {
                alert(`Cập nhật tài khoản Khách hàng ID: ${currentUserId} thành công!`);
                closeModal();
                fetchCustomers(); 
            } else {
                const errorData = await response.json();
                alert(`Lỗi: ${errorData.detail || 'Không thể thực hiện cập nhật.'}`);
            }
        } catch (error) {
            console.error('Lỗi kết nối:', error);
            alert('Lỗi kết nối đến máy chủ.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Cập nhật';
        }
    });

    // --- HÀM HÀNH ĐỘNG KÍCH HOẠT/VÔ HIỆU HÓA ---
    async function toggleStatus(userId, currentIsActive) {
        const newIsActive = !currentIsActive;
        const action = newIsActive ? 'Mở khóa' : 'Khóa';

        if (!confirm(`Bạn có chắc chắn muốn ${action} tài khoản Khách hàng ID: ${userId}?`)) {
            return;
        }

        const toggleBtn = document.querySelector(`button[data-user-id="${userId}"]`);
        toggleBtn.disabled = true;
        const originalText = toggleBtn.innerHTML;
        toggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

        try {
            // SỬ DỤNG API ENDPOINT MỚI CHO CUSTOMER
            const response = await fetch(`${CUSTOMER_API_BASE}/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                // CHỈ GỬI TRƯỜNG IsActive (backend cần xử lý PUT một phần)
                body: JSON.stringify({ IsActive: newIsActive }) 
            });

            if (response.ok) {
                alert(`${action} tài khoản ID ${userId} thành công!`);
                fetchCustomers(); // Tải lại bảng để cập nhật trạng thái
            } else {
                const errorData = await response.json();
                alert(`Lỗi khi ${action.toLowerCase()}: ${errorData.detail || 'Không thể cập nhật trạng thái.'}`);
            }
        } catch (error) {
            console.error('Lỗi kết nối:', error);
            alert('Lỗi kết nối đến máy chủ.');
        } finally {
            toggleBtn.disabled = false;
            toggleBtn.innerHTML = originalText;
        }
    }

    // --- KHỞI TẠO ---
    document.addEventListener('DOMContentLoaded', fetchCustomers);
    </script>
</body>
</html>