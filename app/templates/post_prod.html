<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Đăng bán sản phẩm</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f9fafb;
      font-family: "Segoe UI", sans-serif;
    }
    .container {
      max-width: 600px;
      margin-top: 60px;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .card-header {
      background-color: #4f46e5;
      color: white;
      font-weight: bold;
    }
    button {
      border-radius: 8px !important;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Form đăng nhập -->
  <div class="card" id="loginCard">
    <div class="card-header text-center">Đăng nhập</div>
    <div class="card-body">
      <form id="loginForm">
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" placeholder="example@email.com" required>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Mật khẩu</label>
          <input type="password" class="form-control" id="password" placeholder="••••••" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Đăng nhập</button>
      </form>
    </div>
  </div>

  <!-- Form đăng bán sản phẩm -->
  <div class="card d-none" id="sellCard">
    <div class="card-header text-center">Đăng bán sản phẩm</div>
    <div class="card-body">
      <form id="sellForm">
        <div class="mb-3">
          <label for="title" class="form-label">Tên sản phẩm</label>
          <input type="text" class="form-control" id="title" required>
        </div>
        <div class="mb-3">
          <label for="category" class="form-label">Danh mục</label>
          <select id="category" class="form-select" required>
            <option value="">-- Chọn danh mục --</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="price" class="form-label">Giá</label>
          <input type="number" step="0.01" class="form-control" id="price" required>
        </div>
        <div class="mb-3">
          <label for="quantity" class="form-label">Số lượng</label>
          <input type="number" class="form-control" id="quantity" required>
        </div>
        <div class="mb-3">
          <label for="videoUrl" class="form-label">Video URL</label>
          <input type="url" class="form-control" id="videoUrl" placeholder="https://example.com/video.mp4" required>
        </div>
        <div class="mb-3">
          <label for="desc" class="form-label">Mô tả</label>
          <textarea id="desc" class="form-control" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-success w-100">Đăng bán</button>
      </form>
      <button class="btn btn-outline-danger w-100 mt-3" id="logoutBtn">Đăng xuất</button>
    </div>
  </div>
</div>

<script>
  const apiBase = "http://127.0.0.1:8000/api/v1";

  if (localStorage.getItem("token")) {
    showSellForm();
  }

  async function showSellForm() {
    document.getElementById("loginCard").classList.add("d-none");
    document.getElementById("sellCard").classList.remove("d-none");

    try {
      const res = await fetch(`${apiBase}/categories/`);
      if (!res.ok) throw new Error("Không thể tải danh mục");

      const data = await res.json();
      const select = document.getElementById("category");
      select.innerHTML = '<option value="">-- Chọn danh mục --</option>';
      data.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat.CategoryID;
        opt.textContent = cat.CategoryName;
        select.appendChild(opt);
      });
    } catch (err) {
      console.error("Lỗi tải danh mục:", err);
      alert("⚠️ Lỗi tải danh mục!");
    }
  }

  document.getElementById("loginForm").addEventListener("submit", async e => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    try {
      const res = await fetch(`${apiBase}/auth/token`, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({ username: email, password })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Sai thông tin đăng nhập");
      }

      const data = await res.json();
      localStorage.setItem("token", data.access_token);
      alert("✅ Đăng nhập thành công!");
      showSellForm();
    } catch (err) {
      alert("❌ " + err.message);
    }
  });

  document.getElementById("sellForm").addEventListener("submit", async e => {
    e.preventDefault();
    const formData = {
      Title: document.getElementById("title").value,
      CategoryID: parseInt(document.getElementById("category").value),
      Price: parseFloat(document.getElementById("price").value),
      Quantity: parseInt(document.getElementById("quantity").value),
      VideoUrl: document.getElementById("videoUrl").value, // ✅ thêm dòng này
      Description: document.getElementById("desc").value
    };

    try {
      const res = await fetch(`${apiBase}/products/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify(formData)
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Không xác định");
      alert("✅ Sản phẩm đã được đăng!");
      document.getElementById("sellForm").reset();
    } catch (err) {
      alert("❌ Lỗi đăng sản phẩm: " + err.message);
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("token");
    location.reload();
  });
</script>
</body>
</html>
