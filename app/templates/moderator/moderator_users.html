<!DOCTYPE html>
<html>
<head>
    <title>Quản Lý Khách Hàng - Moderator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Cơ bản */
        body { 
            font-family: 'Arial', sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f4f9; 
            display: flex; 
            min-height: 100vh; 
        }
        .sidebar { 
            width: 250px; 
            background-color: #2c3e50; 
            color: white; 
            padding-top: 20px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            position: fixed; 
            height: 100%; 
            overflow-y: auto; 
            /* ĐỒNG BỘ: Dùng Flexbox để đẩy Đăng xuất xuống cuối (Giống chuẩn) */
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
        }
        .sidebar h3 { /* ĐỒNG BỘ: Thêm style cho h3 trong sidebar */
            padding: 10px 20px; 
            font-size: 1.25rem; 
            border-bottom: 1px solid #34495e; 
            margin-bottom: 10px; 
        }
        .sidebar a { 
            padding: 15px 20px; 
            text-decoration: none; 
            font-size: 16px; 
            color: #ecf0f1; 
            display: flex; /* ĐỒNG BỘ */
            align-items: center;
            transition: background-color 0.3s; 
            border-left: 5px solid transparent; 
        }
        .sidebar a:hover, .sidebar a.active { 
            background-color: #34495e; 
            border-left: 5px solid #3498db; 
            color: white; 
        }
        .sidebar a i { 
            margin-right: 10px; 
            width: 20px; 
            text-align: center; 
        }
        .main-content { margin-left: 250px; flex-grow: 1; padding: 20px; }
        .header-bar { background: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .content-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .user-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .user-table th, .user-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .user-table th { background-color: #f8f8f8; font-weight: bold; color: #333; }
        .action-btn { padding: 5px 10px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: background-color 0.3s; }
        .toggle-status-btn.active { background-color: #e74c3c; } /* Khóa (Nếu đang Active) */
        .toggle-status-btn.inactive { background-color: #2ecc71; } /* Mở khóa (Nếu đang Inactive) */
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .status-pill.active { background-color: #2ecc71; color: white; }
        .status-pill.inactive { background-color: #e74c3c; color: white; } /* Màu đỏ cho trạng thái khóa */

        /* ĐỒNG BỘ: Thêm CSS cho Custom Modal/Message Box (Giống chuẩn) */
        .modal { 
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; 
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); 
        }
        .message-box { 
            background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            width: 90%; max-width: 400px; text-align: center; margin: 15% auto; animation: scaleIn 0.2s ease-out; 
        }
        .message-box h4 { font-size: 1.25rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .message-box p { margin-bottom: 20px; color: #555; }
        .action-btn.detail-btn { background-color: #3498db; }
        .action-btn.reject-btn { background-color: #e74c3c; } 
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="customMessageBox" class="modal">
        <div class="message-box">
            <h4 id="messageBoxTitle">Tiêu đề</h4>
            <p id="messageBoxContent">Nội dung thông báo.</p>
            <div id="messageBoxActions"></div>
        </div>
    </div>
    
    <div class="sidebar">
        <div>
            <h3><i class="fas fa-gavel"></i> Khu vực Moderator</h3> 
            <div style="padding: 10px 0;">
                <a href="/moderator/moderator_dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
                <h4 style="color: #bdc3c7; font-size: 0.9em; padding: 10px 20px 5px;">Quản lý Kiểm duyệt</h4>
                <a href="/moderator/moderator_products.html"><i class="fas fa-box"></i> Duyệt Sản phẩm</a>
                <a href="/moderator/moderator_users.html" class="active"><i class="fas fa-users-slash"></i> Mở/Khóa Tài khoản</a>
                <div style="padding: 10px 0; border-top: 1px solid #34495e;">
                    <a href="#" id="logoutBtn" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="header-bar">
            <h2>Quản Lý Tài khoản Khách Hàng</h2>
        </div>
        <div class="content-box">
            <h3>Danh sách Tài khoản Khách hàng (RoleID=3)</h3>
            <table class="user-table" id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Tên đầy đủ</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        const tableBody = document.querySelector('#usersTable tbody');
        const CUSTOMER_API_BASE = '/api/v1/users/customer'; // API Endpoint cho Khách hàng
        
        // --- CONSTANTS ---
        // ĐỒNG BỘ: Khai báo các biến DOM cho Modal (Giống chuẩn)
        const msgBox = document.getElementById('customMessageBox');
        const msgBoxTitle = document.getElementById('messageBoxTitle');
        const msgBoxContent = document.getElementById('messageBoxContent');
        const msgBoxActions = document.getElementById('messageBoxActions');

        // --- CUSTOM MESSAGE BOX IMPLEMENTATION (ĐỒNG BỘ từ moderator_products.html) ---
        function showCustomMessage(title, message, isConfirm, callback = null) {
            msgBoxTitle.textContent = title;
            msgBoxContent.innerHTML = message;
            msgBoxActions.innerHTML = '';
            msgBox.style.display = 'block';

            const closeMessage = () => {
                msgBox.style.display = 'none';
            };

            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'action-btn detail-btn'; 
                confirmBtn.textContent = 'Xác nhận';
                confirmBtn.onclick = () => {
                    closeMessage();
                    if (callback) callback(true);
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'action-btn reject-btn'; 
                cancelBtn.textContent = 'Hủy bỏ';
                cancelBtn.onclick = () => {
                    closeMessage();
                    if (callback) callback(false);
                };

                msgBoxActions.appendChild(confirmBtn);
                msgBoxActions.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'action-btn detail-btn'; 
                okBtn.textContent = 'Đóng';
                okBtn.onclick = closeMessage;
                msgBoxActions.appendChild(okBtn);
            }
        }
        
        // --- LOGOUT FUNCTION (Bây giờ đã hoạt động) ---
        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_role');
            localStorage.removeItem('user_name');
            showCustomMessage(
                'Xác nhận Đăng xuất',
                'Bạn có chắc chắn muốn đăng xuất khỏi khu vực Moderator?',
                true,
                (confirmed) => {
                    if (confirmed) {
                        // TODO: Implement actual logout logic (clear token, redirect to login page)
                        window.location.href = "http://127.0.0.1:8000/"; 
                    }
                }
            );
        }

        // --- HÀM TẢI DỮ LIỆU BẢNG (Giữ nguyên) --- 
        async function fetchCustomers() {
            tableBody.innerHTML = '<tr><td colspan="6">Đang tải dữ liệu...</td></tr>';
            try {
                const response = await fetch(CUSTOMER_API_BASE, { method: 'GET' });
                if (response.ok) {
                    const customers = await response.json();
                    renderTable(customers);
                } else {
                    const errorData = await response.json();
                    tableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Lỗi tải dữ liệu: ${errorData.detail || 'Lỗi không xác định'}</td></tr>`;
                }
            } catch (error) {
                console.error('Lỗi API:', error);
                tableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Không thể kết nối đến máy chủ API.</td></tr>';
            }
        }

        function renderTable(customers) {
            tableBody.innerHTML = '';
            if (customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">Chưa có tài khoản Khách hàng nào.</td></tr>';
                return;
            }
            customers.forEach(user => {
                const isBanned = user.IsActive !== true; // Coi IsActive=false là bị khóa/banned
                const statusText = isBanned ? 'Bị khóa' : 'Active';
                const statusClass = isBanned ? 'inactive' : 'active';
                const actionText = isBanned ? 'Mở khóa' : 'Khóa';
                const actionIcon = isBanned ? 'fas fa-check' : 'fas fa-ban';
                const actionClass = isBanned ? 'inactive' : 'active';
                const row = `
                    <tr>
                        <td>${user.UserID}</td>
                        <td>${user.Username}</td>
                        <td>${user.Email}</td>
                        <td>${user.FullName}</td>
                        <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                        <td> 
                            <button class="action-btn toggle-status-btn ${actionClass}" data-user-id="${user.UserID}" onclick="toggleStatus(${user.UserID}, ${!isBanned})">
                                <i class="${actionIcon}"></i> ${actionText} 
                            </button> 
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        // --- HÀM HÀNH ĐỘNG KHÓA/MỞ KHÓA (Toggle Status - ĐÃ DÙNG showCustomMessage) ---
        async function toggleStatus(userId, currentIsActive) {
            const newIsActive = !currentIsActive;
            const action = newIsActive ? 'Mở khóa' : 'Khóa'; 
            
            showCustomMessage(
                `Xác nhận ${action}`,
                `Bạn có chắc chắn muốn <strong>${action}</strong> tài khoản Khách hàng ID: <strong>${userId}</strong>?`,
                true,
                async (confirmed) => {
                    if (!confirmed) return;
                    
                    const toggleBtn = document.querySelector(`button[data-user-id="${userId}"]`);
                    toggleBtn.disabled = true;
                    const originalText = toggleBtn.innerHTML;
                    toggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

                    try {
                        // Gửi yêu cầu PUT đến API để cập nhật trạng thái IsActive
                        const response = await fetch(`${CUSTOMER_API_BASE}/${userId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ IsActive: newIsActive })
                        });

                        if (response.ok) {
                            showCustomMessage('Thành công', `${action} tài khoản ID ${userId} thành công!`, false);
                            fetchCustomers(); // Tải lại bảng để cập nhật trạng thái
                        } else {
                            const errorData = await response.json();
                            showCustomMessage('Lỗi', `Lỗi khi ${action.toLowerCase()}: ${errorData.detail || 'Không thể cập nhật trạng thái.'}`, false);
                        }
                    } catch (error) {
                        console.error('Lỗi kết nối:', error);
                        showCustomMessage('Lỗi kết nối', 'Lỗi kết nối đến máy chủ.', false);
                    } finally {
                        if (!response || !response.ok) {
                             toggleBtn.disabled = false;
                             toggleBtn.innerHTML = originalText;
                        }
                    }
                }
            );
        }

        // --- KHỞI TẠO --- 
        document.addEventListener('DOMContentLoaded', fetchCustomers);
    </script>
</body>
</html>