<!DOCTYPE html>
<html>
<head>
    <title>Qu·∫£n L√Ω S·∫£n Ph·∫©m - Moderator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS C∆° b·∫£n */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: fixed;
            height: 100%;
            overflow-y: auto;
            z-index: 50;
            display: flex; /* D√πng flexbox cho sidebar */
            flex-direction: column;
            justify-content: space-between; /* ƒê·∫©y Logout xu·ªëng cu·ªëi */
        }
        .sidebar h3 {
            padding: 10px 20px;
            font-size: 1.25rem;
            border-bottom: 1px solid #34495e;
            margin-bottom: 10px;
        }
        .sidebar a {
            padding: 15px 20px;
            text-decoration: none;
            font-size: 16px;
            color: #ecf0f1;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
            border-left: 5px solid transparent;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #34495e;
            border-left: 5px solid #3498db;
            color: white;
        }
        .sidebar a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .main-content {
            margin-left: 250px;
            flex-grow: 1;
            padding: 20px;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .main-content {
                margin-left: 0;
            }
        }
        .header-bar {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
        }
        .content-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .product-table th, .product-table td {
            padding: 15px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .product-table th {
            background-color: #ecf0f1;
            font-weight: 600;
            color: #333;
        }
        .product-table tr:hover {
            background-color: #fcfcfc;
        }

        .action-btn {
            padding: 8px 12px;
            margin: 4px 2px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 500;
        }
        .action-btn:hover {
            transform: translateY(-1px);
        }
        /* Chi ti·∫øt - M√†u xanh d∆∞∆°ng */
        .detail-btn { background-color: #3498db; } 
        /* Duy·ªát/Duy·ªát l·∫°i - M√†u xanh l√° */
        .approve-btn { background-color: #2ecc71; } 
        /* T·ª´ ch·ªëi - M√†u ƒë·ªè */
        .reject-btn { background-color: #e74c3c; } 
        /* Chuy·ªÉn v·ªÅ Ch·ªù - M√†u cam (ho·∫∑c x√°m/tr·∫Øng) */
        .pending-btn { background-color: #f39c12; } 

        .status-pill {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
        }
        .status-pill.approved { background-color: #2ecc71; color: white; }
        .status-pill.pending { background-color: #f39c12; color: white; } 
        .status-pill.rejected { background-color: #e74c3c; color: white; } 

        /* Custom Modal Styling - Gi·ªØ nguy√™n */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 30px; border: none;
            width: 90%; max-width: 700px; border-radius: 10px; position: relative;
            animation: fadeIn 0.3s;
        }
        .close-btn { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: #333; }

        .modal-content input, .modal-content textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px;
            border: 1px solid #ddd; box-sizing: border-box; background-color: #f9f9f9;
        }
        .modal-content textarea {
            resize: vertical;
        }
        
        /* Custom Message Box Styling - Gi·ªØ nguy√™n */
        #customMessageBox { z-index: 2000; }
        .message-box {
            background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%; max-width: 400px; text-align: center; margin: 15% auto; animation: scaleIn 0.2s ease-out;
        }
        .message-box h4 { font-size: 1.25rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .message-box p { margin-bottom: 20px; color: #555; }
        .message-box .confirm-btn { background-color: #e74c3c; color: white; border: none; }
        .message-box .cancel-btn { background-color: #bdc3c7; color: #333; border: 1px solid #95a5a6; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body onload="fetchProducts()">
    <div class="sidebar">
        <div> 
            <h3><i class="fas fa-gavel"></i> Khu v·ª±c Moderator</h3>
            <div style="padding: 10px 0;">
                <a href="/moderator/moderator_dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
                <h4 style="color: #bdc3c7; font-size: 0.9em; padding: 10px 20px 5px;">Qu·∫£n l√Ω Ki·ªÉm duy·ªát</h4>
                <a href="/moderator/moderator_products.html" class="active"><i class="fas fa-box"></i> Duy·ªát S·∫£n ph·∫©m</a>
                <a href="/moderator/moderator_users.html"><i class="fas fa-users-slash"></i> M·ªü/Kh√≥a T√†i kho·∫£n</a>
                <div style="padding: 10px 0; border-top: 1px solid #34495e;">
                    <a href="#" id="logoutBtn" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <h2>Qu·∫£n L√Ω Duy·ªát S·∫£n Ph·∫©m</h2>
        </div>
        <div class="content-box">
            <h3>Danh s√°ch S·∫£n ph·∫©m C·∫ßn Duy·ªát v√† ƒê√£ Duy·ªát</h3>
            <table class="product-table" id="productsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Ng∆∞·ªùi b√°n</th> 
                        <th>Li√™n h·ªá</th> 
                        <th>Gi√°</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="7">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="productModal" class="modal" onclick="if(event.target.id === 'productModal') closeModal()">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle" class="text-xl font-bold mb-4">Chi ti·∫øt S·∫£n ph·∫©m</h3>
            <form id="productForm">
                <div class="mb-3">
                    <label class="block text-gray-700 font-medium mb-1">H√¨nh ·∫£nh S·∫£n ph·∫©m (ch√≠nh)</label>
                    <div id="productImageContainer" class="border border-gray-300 p-2 rounded-lg bg-gray-100">
                        <img id="productImage" src="/static/images/products/..." alt="H√¨nh ·∫£nh s·∫£n ph·∫©m" style="max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 4px;">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-gray-700 font-medium mb-1">Video M√¥ t·∫£ (Cho Mod Check)</label>
                    <a id="productVideoLink" href="#" target="_blank" 
                    class="block w-full p-3 mb-1 border-2 border-dashed border-blue-400 rounded-lg text-blue-600 hover:text-blue-800 hover:border-blue-600 transition duration-150 truncate">
                    <i class="fas fa-link mr-2"></i> Kh√¥ng c√≥ Video
                    </a>
                    <input type="hidden" id="productVideoUrlHidden">
                    <p class="text-xs text-gray-500 mt-1">(*) Mod check vui l√≤ng nh·∫•n v√†o ƒë∆∞·ªùng link tr√™n ƒë·ªÉ xem chi ti·∫øt video.</p>
                </div>
                <input type="hidden" id="productID" name="ProductID">
                <div class="mb-3">
                    <label class="block text-gray-700 font-medium mb-1">T√™n s·∫£n ph·∫©m</label>
                    <input type="text" id="productTitle" name="Title" required disabled class="bg-gray-100 cursor-not-allowed">
                </div>
                <div class="mb-3">
                    <label class="block text-gray-700 font-medium mb-1">M√¥ t·∫£</label>
                    <textarea id="productDescription" name="Description" rows="5" disabled class="bg-gray-100 cursor-not-allowed"></textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-gray-700 font-medium mb-1">Gi√° (VND)</label>
                    <input type="text" id="productPrice" name="Price" required disabled class="bg-gray-100 cursor-not-allowed">
                </div>
                <p class="text-sm italic text-blue-500 mt-4">
                    (*) Chi ti·∫øt s·∫£n ph·∫©m ch·ªâ mang t√≠nh ch·∫•t xem (read-only).
                </p>
            </form>
        </div>
    </div>

    <div id="customMessageBox" class="modal">
        <div class="message-box">
            <h4 id="messageBoxTitle">Ti√™u ƒë·ªÅ</h4>
            <p id="messageBoxContent">N·ªôi dung th√¥ng b√°o.</p>
            <div id="messageBoxActions">
                </div>
        </div>
    </div>


    <script>
        // --- CONSTANTS ---
        const modal = document.getElementById('productModal');
        const form = document.getElementById('productForm');
        const modalTitle = document.getElementById('modalTitle');
        const tableBody = document.querySelector('#productsTable tbody');
        const msgBox = document.getElementById('customMessageBox');
        const msgBoxTitle = document.getElementById('messageBoxTitle');
        const msgBoxContent = document.getElementById('messageBoxContent');
        const msgBoxActions = document.getElementById('messageBoxActions');

        const API_BASE = '/api/v1/products'; 
        const FETCH_URL = `${API_BASE}/moderator/all`; 
        const STATUS_UPDATE_URL = `${API_BASE}/status`; 

        const STATUS_PENDING = 0;
        const STATUS_APPROVED = 1;
        const STATUS_REJECTED = 2; 

        let currentProductId = null;

        // --- LOGOUT FUNCTION ---
        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_role');
            localStorage.removeItem('user_name');
            showCustomMessage(
                'X√°c nh·∫≠n ƒêƒÉng xu·∫•t',
                'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi khu v·ª±c Moderator?',
                true,
                (confirmed) => {
                    if (confirmed) {
                        // TODO: Implement actual logout logic (clear token, redirect to login page)
                        // V√≠ d·ª•: localStorage.removeItem('access_token');
                        window.location.href = "http://127.0.0.1:8000/"; 
                    }
                }
            );
        }

        // --- CUSTOM MESSAGE BOX IMPLEMENTATION (ALERT/CONFIRM REPLACEMENT) ---

        function showCustomMessage(title, message, isConfirm, callback = null) {
            msgBoxTitle.textContent = title;
            msgBoxContent.innerHTML = message;
            msgBoxActions.innerHTML = '';
            msgBox.style.display = 'block';

            const closeMessage = () => {
                msgBox.style.display = 'none';
            };

            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                // Thay ƒë·ªïi m√†u n√∫t x√°c nh·∫≠n th√†nh m√†u xanh d∆∞∆°ng cho h√†nh ƒë·ªông √≠t ti√™u c·ª±c h∆°n
                confirmBtn.className = 'action-btn detail-btn'; 
                confirmBtn.textContent = 'X√°c nh·∫≠n';
                confirmBtn.onclick = () => {
                    closeMessage();
                    if (callback) callback(true);
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'action-btn reject-btn'; // D√πng m√†u ƒë·ªè cho n√∫t h·ªßy
                cancelBtn.textContent = 'H·ªßy b·ªè';
                cancelBtn.onclick = () => {
                    closeMessage();
                    if (callback) callback(false);
                };

                msgBoxActions.appendChild(confirmBtn);
                msgBoxActions.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'action-btn detail-btn'; 
                okBtn.textContent = 'ƒê√≥ng';
                okBtn.onclick = closeMessage;
                msgBoxActions.appendChild(okBtn);
            }
        }

        // --- MAIN MODAL LOGIC (Product Details View) ---
        // --- MAIN MODAL LOGIC (Product Details View) ---
        function closeModal() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        async function editProduct(productId) {
            currentProductId = productId;
            modalTitle.textContent = `Chi ti·∫øt S·∫£n ph·∫©m ID: ${productId}`;
            form.reset();
            document.getElementById('productID').value = productId;

            // L·∫§Y C√ÅC BI·∫æN M·ªöI
            const videoLinkElement = document.getElementById('productVideoLink');
            const videoHiddenElement = document.getElementById('productVideoUrlHidden');
            const productImageElement = document.getElementById('productImage');
            const imageContainerElement = document.getElementById('productImageContainer');
            
            // 1. Reset c√°c tr∆∞·ªùng (Quan tr·ªçng: X√≥a d√≤ng l·ªói c≈© ·ªü ƒë√¢y)
            productImageElement.src = '';
            imageContainerElement.style.display = 'none';
            
            // Reset Video Link
            videoLinkElement.href = "#";
            videoLinkElement.textContent = "Kh√¥ng c√≥ Video M√¥ t·∫£";
            videoLinkElement.classList.remove('border-green-400');
            videoLinkElement.classList.add('border-blue-400');
            videoHiddenElement.value = '';

            try {
                // 2. Fetch chi ti·∫øt s·∫£n ph·∫©m
                const response = await fetch(`${API_BASE}/${productId}`, { method: 'GET' });
                
                if (response.ok) {
                    const productData = await response.json();
                    
                    // 3. G√°n c√°c tr∆∞·ªùng c∆° b·∫£n
                    document.getElementById('productTitle').value = productData.Title || '';
                    document.getElementById('productDescription').value = productData.Description || '';
                    document.getElementById('productPrice').value = (productData.Price || 0).toLocaleString('vi-VN') + ' VND';

                    // 4. G√°n URL Video v√† Image (Key ƒë√£ ƒë∆∞·ª£c s·ª≠a)
                    const videoUrl = productData.VideoUrl || '';      // S·ª¨A: Key ch√≠nh x√°c
                    const imageUrl = productData.PrimaryImageUrl || ''; // S·ª¨A: Key ch√≠nh x√°c

                    // G√°n URL Video (v√†o th·∫ª <a>)
                    if (videoUrl) {
                        videoHiddenElement.value = videoUrl;
                        videoLinkElement.href = videoUrl;
                        // Hi·ªÉn th·ªã m·ªôt ph·∫ßn c·ªßa URL (ho·∫∑c to√†n b·ªô)
                        videoLinkElement.textContent = videoUrl.length > 
                                                        50 ? videoUrl.substring(0, 47) + '...' : videoUrl; 
                        videoLinkElement.classList.remove('border-blue-400');
                        videoLinkElement.classList.add('border-green-400');
                    }

                    // G√°n URL H√¨nh ·∫£nh
                    if (imageUrl) {
                        productImageElement.src = imageUrl; 
                        imageContainerElement.style.display = 'block';
                    } else {
                        imageContainerElement.style.display = 'none';
                    }
                    
                    // üåü 5. HI·ªÇN TH·ªä MODAL
                    modal.style.display = 'block'; 
                    
                } else {
                    const errorDetails = await getErrorDetails(response);
                    showCustomMessage(
                        'L·ªói t·∫£i chi ti·∫øt s·∫£n ph·∫©m', 
                        `<p>Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu chi ti·∫øt cho s·∫£n ph·∫©m ID ${productId}.</p><p style="color: red;"><strong>Chi ti·∫øt:</strong> ${errorDetails}</p>`, 
                        false
                    );
                }
            } catch (error) {
                console.error('L·ªói API Get:', error);
                showCustomMessage(
                    'L·ªói k·∫øt n·ªëi', 
                    '<p>L·ªói k·∫øt n·ªëi m·∫°ng khi l·∫•y d·ªØ li·ªáu chi ti·∫øt s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.</p>', 
                    false
                );
            }
        }
        
        // --- API HELPER FUNCTIONS S·ª¨A L·ªñI HI·ªÇN TH·ªä ---
        async function getErrorDetails(response) {
            try {
                const errorData = await response.json();
                
                if (errorData.detail) {
                    if (Array.isArray(errorData.detail)) {
                        return JSON.stringify(errorData.detail, null, 2);
                    }
                    return errorData.detail;
                }

                if (errorData.message) {
                    return errorData.message;
                }

                return JSON.stringify(errorData, null, 2); 
            } catch (e) {
                const textError = await response.text();
                return `L·ªói kh√¥ng ph·∫£i JSON (Status: ${response.status}). N·ªôi dung: ${textError.substring(0, 100)}...`;
            }
        }

        // --- MAIN TABLE DATA FETCHING ---
        async function fetchProducts() {
            tableBody.innerHTML = '<tr><td colspan="7"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            try {
                const response = await fetch(FETCH_URL, { method: 'GET' });
                if (response.ok) {
                    const products = await response.json();
                    renderTable(products);
                } else {
                    const errorDetails = await getErrorDetails(response);
                    tableBody.innerHTML = `<tr><td colspan="7" style="color: red; font-weight: bold;">L·ªñI T·∫¢I D·ªÆ LI·ªÜU: ${errorDetails}</td></tr>`;
                }
            } catch (error) {
                console.error('L·ªói API:', error);
                tableBody.innerHTML = '<tr><td colspan="7" style="color: red; font-weight: bold;">Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß API (L·ªói m·∫°ng ho·∫∑c CORS).</td></tr>';
            }
        }

        function getStatusInfo(status) {
            switch (status) {
                case STATUS_APPROVED:
                    // ƒê√£ Duy·ªát: Gi·ªØ l·∫°i 2 l·ª±a ch·ªçn: Chuy·ªÉn v·ªÅ Ch·ªù (0) ho·∫∑c T·ª´ ch·ªëi (2)
                    return { text: 'ƒê√£ duy·ªát', class: 'approved', action_buttons: [
                        { text: 'Chuy·ªÉn v·ªÅ Ch·ªù', class: 'pending-btn', icon: 'fas fa-arrow-alt-circle-left', status: STATUS_PENDING, action: 'Chuy·ªÉn v·ªÅ Ch·ªù Duy·ªát' },
                        { text: 'T·ª´ ch·ªëi', class: 'reject-btn', icon: 'fas fa-times-circle', status: STATUS_REJECTED, action: 'T·ª´ ch·ªëi duy·ªát' }
                    ]}; 
                case STATUS_PENDING:
                    // Ch·ªù Duy·ªát: Ch·ªâ Duy·ªát (1) ho·∫∑c T·ª´ ch·ªëi (2)
                    return { text: 'Ch·ªù duy·ªát', class: 'pending', action_buttons: [
                        { text: 'Duy·ªát ngay', class: 'approve-btn', icon: 'fas fa-check-circle', status: STATUS_APPROVED, action: 'Duy·ªát' },
                        { text: 'T·ª´ ch·ªëi', class: 'reject-btn', icon: 'fas fa-times-circle', status: STATUS_REJECTED, action: 'T·ª´ ch·ªëi duy·ªát' }
                    ]};
                case STATUS_REJECTED:
                    // T·ª´ ch·ªëi: Duy·ªát l·∫°i (1) ho·∫∑c Chuy·ªÉn v·ªÅ Ch·ªù (0)
                    return { text: 'T·ª´ ch·ªëi', class: 'rejected', action_buttons: [
                        { text: 'Duy·ªát l·∫°i', class: 'approve-btn', icon: 'fas fa-check-circle', status: STATUS_APPROVED, action: 'Duy·ªát l·∫°i' },
                        { text: 'Chuy·ªÉn v·ªÅ Ch·ªù', class: 'pending-btn', icon: 'fas fa-arrow-alt-circle-left', status: STATUS_PENDING, action: 'Chuy·ªÉn v·ªÅ Ch·ªù Duy·ªát' }
                    ]};
                default:
                    return { text: 'Kh√¥ng r√µ', class: 'text-gray-500', action_buttons: [] };
            }
        }

        function renderTable(products) {
            tableBody.innerHTML = '';
            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o c·∫ßn ki·ªÉm duy·ªát ho·∫∑c ƒë√£ duy·ªát.</td></tr>';
                return;
            }

            products.forEach(product => {
                const statusInfo = getStatusInfo(product.Status);
                
                // Gi·∫£ ƒë·ªãnh backend tr·∫£ v·ªÅ object Seller (c·∫ßn s·ª≠a backend)
                const seller = product.seller || { FullName: 'N/A', Email: 'N/A', PhoneNumber: 'N/A' }; 
                const sellerInfo = `<strong>${seller.FullName}</strong> <span class="text-xs text-gray-400"> (ID: ${product.SellerID})</span>`;

                const contactInfo = `
                    <span class="text-xs">
                        <i class="fas fa-envelope mr-1"></i>${seller.Email}<br>
                        <i class="fas fa-phone mr-1"></i>${seller.PhoneNumber}
                    </span>
                `;
                
                // N√∫t Chi ti·∫øt lu√¥n hi·ªÉn th·ªã ƒë·∫ßu ti√™n
                let actionButtonsHTML = `<button class="action-btn detail-btn" onclick="editProduct(${product.ProductID})"><i class="fas fa-eye"></i> Chi ti·∫øt</button>`;
                
                // Duy·ªát/T·ª´ ch·ªëi/Chuy·ªÉn ch·ªù (ch·ªâ 2 n√∫t li√™n quan)
                statusInfo.action_buttons.forEach(btn => {
                    actionButtonsHTML += `
                        <button class="action-btn ${btn.class}" 
                            data-product-id="${product.ProductID}" 
                            onclick="toggleApproval(${product.ProductID}, ${btn.status}, '${btn.action}', this)">
                            <i class="${btn.icon}"></i> ${btn.text}
                        </button>
                    `;
                });


                const row = `
                    <tr>
                        <td>${product.ProductID}</td>
                        <td class="font-medium">${product.Title || 'N/A'}</td>
                        <td class="text-sm">${sellerInfo}</td>
                        <td>${contactInfo}</td>
                        <td>${(product.Price || 0).toLocaleString('vi-VN')} VND</td>
                        <td><span class="status-pill ${statusInfo.class}">${statusInfo.text}</span></td>
                        <td>
                            ${actionButtonsHTML}
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- APPROVAL TOGGLE LOGIC ---
        // Th√™m tham s·ªë 'clickedButton' ƒë·ªÉ ch·ªâ v√¥ hi·ªáu h√≥a c√°c n√∫t li√™n quan
        async function toggleApproval(productId, newStatus, action, clickedButton) { 
            const newStatusName = 
                newStatus === STATUS_APPROVED ? 'Duy·ªát' : 
                newStatus === STATUS_PENDING ? 'Chuy·ªÉn v·ªÅ Ch·ªù Duy·ªát' : 
                'T·ª´ ch·ªëi'; 

            showCustomMessage(
                `X√°c nh·∫≠n ${action}`,
                `<p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën <strong>${action}</strong> s·∫£n ph·∫©m ID: <strong>${productId}</strong>? (Tr·∫°ng th√°i m·ªõi: ${newStatusName})</p>`,
                true,
                async (confirmed) => {
                    if (!confirmed) return;

                    // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ c√°c n√∫t h√†nh ƒë·ªông c·ªßa s·∫£n ph·∫©m n√†y
                    const allActionBtns = document.querySelectorAll(`#productsTable tr button`);
                    allActionBtns.forEach(btn => {
                        if (btn.parentElement.parentElement.querySelector(`td:first-child`).textContent.trim() == productId) {
                            btn.disabled = true;
                        }
                    });


                    // Hi·ªáu ·ª©ng t·∫£i cho n√∫t v·ª´a ƒë∆∞·ª£c nh·∫•n
                    const originalText = clickedButton.innerHTML;
                    clickedButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

                    try {
                        const response = await fetch(`${STATUS_UPDATE_URL}/${productId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ Status: newStatus }) 
                        });

                        if (response.ok) {
                            showCustomMessage('Th√†nh c√¥ng', `${action} s·∫£n ph·∫©m ID ${productId} th√†nh c√¥ng!`, false);
                            fetchProducts(); // T·∫£i l·∫°i b·∫£ng ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                        } else {
                            const errorDetails = await getErrorDetails(response);
                            showCustomMessage(
                                'L·ªói', 
                                `<p>L·ªói khi ${action.toLowerCase()} s·∫£n ph·∫©m ID ${productId}.</p><p style="color: red;"><strong>Chi ti·∫øt:</strong> ${errorDetails}</p>`, 
                                false
                            );
                        }
                    } catch (error) {
                        console.error('L·ªói k·∫øt n·ªëi:', error);
                        showCustomMessage('L·ªói k·∫øt n·ªëi', 'L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra m·∫°ng.', false);
                    } finally {
                        // N·∫øu fetchProducts() kh√¥ng ƒë∆∞·ª£c g·ªçi (v√≠ d·ª•: l·ªói), c·∫ßn k√≠ch ho·∫°t l·∫°i c√°c n√∫t
                        if (!response || !response.ok) {
                             allActionBtns.forEach(btn => {
                                if (btn.parentElement.parentElement.querySelector(`td:first-child`).textContent.trim() == productId) {
                                    btn.disabled = false;
                                }
                            });
                            clickedButton.innerHTML = originalText;
                        }
                    }
                }
            );
        }
    </script>
</body>
</html>